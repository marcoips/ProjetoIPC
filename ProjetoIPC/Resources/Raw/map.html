<!DOCTYPE html>
<html>
<head>
    <title>Selecionar Origem e Destino com Endereço</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA89DtPad0zQSUx9syrMzj15LvWO1kEOXM"></script>
    <script>
        let map;
        let markers = [];
        let geocoder;

        function initMap() {
            geocoder = new google.maps.Geocoder();

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 39.3999, lng: -8.2245 }, // centro de Portugal
                zoom: 7,
            });

            map.addListener("click", (e) => {
                if (markers.length >= 2) {
                    alert("Já selecionou origem e destino.");
                    return;
                }

                const label = markers.length === 0 ? "A" : "B";
                const title = markers.length === 0 ? "Origem" : "Destino";

                const marker = new google.maps.Marker({
                    position: e.latLng,
                    map: map,
                    label: label,
                    title: title
                });

                markers.push(marker);

                // Reverse geocode
                geocoder.geocode({ location: e.latLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const address = results[0].formatted_address;
                        console.log(title + ": " + address);

                        // Envia para o C# quando os dois pontos forem definidos
                        if (markers.length === 2) {
                            const origem = markers[0].getTitle() === "Origem" ? address : null;
                            const destino = markers[1].getTitle() === "Destino" ? address : null;

                            // Espera um momento para resolver os dois endereços
                            setTimeout(() => {
                                const url = `coords://set?origem=${encodeURIComponent(origem)}&destino=${encodeURIComponent(destino)}`;
                                window.location.href = url;
                            }, 500);
                        }
                    } else {
                        alert("Erro ao obter endereço: " + status);
                    }
                });
            });
        }
    </script>

</head>
<body onload="initMap()">
    <div id="map"></div>
</body>
</html>
